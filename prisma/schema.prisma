// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum MarginPositionType {
  LONG
  SHORT
}

enum MarginPositionStatus {
  OPEN
  CLOSED
  LIQUIDATED
}

model MarginPosition {
  id                String                @id @default(uuid())
  userId            String
  user              User                  @relation(fields: [userId], references: [id])
  symbol            String
  type              MarginPositionType
  status            MarginPositionStatus  @default(OPEN)
  entryPrice        Float
  currentPrice      Float
  size              Float
  leverage          Float
  stopLoss          Float?
  takeProfit        Float?
  liquidationPrice  Float?
  pnl               Float                 @default(0)
  pnlPercentage     Float                 @default(0)
  marginUsed        Float
  trades            MarginTrade[]
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
}

model MarginTrade {
  id                String                @id @default(uuid())
  positionId        String
  position          MarginPosition        @relation(fields: [positionId], references: [id])
  type              String                // OPEN, CLOSE, ADD_MARGIN, REDUCE_MARGIN
  price             Float
  size              Float
  pnl               Float?
  createdAt         DateTime              @default(now())
}

model StockPrice {
  id                String                @id @default(uuid())
  symbol            String
  price             Float
  open              Float?
  high              Float?
  low               Float?
  close             Float?
  volume            Int?
  timestamp         DateTime              @default(now())
  source            String?               // API source or provider
  
  @@index([symbol])
  @@index([timestamp])
}

model Transaction {
  id                String              @id @default(uuid())
  userId            String
  user              User                @relation(fields: [userId], references: [id])
  amount            Float
  type              String              // DEPOSIT, WITHDRAWAL, TRANSFER, PAYMENT
  description       String?
  status            TransactionStatus   @default(PENDING)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
}

model User {
  id                String         @id @default(uuid())
  email             String         @unique
  name              String?
  password          String
  role              UserRole       @default(USER)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  subscriptions     Subscription[]
  organizationId    String?
  organization      Organization?  @relation(fields: [organizationId], references: [id])
  department        String?
  position          String?
  employeeId        String?
  contactNumber     String?
  status            UserStatus     @default(ACTIVE)
  permissions       String[]       @default([])
  supervisor        String?
  hireDate          DateTime?
  createdBy         String?
  isOrganizationAdmin Boolean      @default(false)
  posts             Post[]
  streams           Stream[]
  sentMessages      Message[]      @relation("SentMessages")
  receivedMessages  Message[]      @relation("ReceivedMessages")
  image             String?
  carts             Cart[]
  orders            Order[]
  futureOrders      FutureOrder[]
  fxFutureOrders    FxFutureOrder[]
  transactions      Transaction[]
  marginPositions   MarginPosition[]
}

model Organization {
  id                String         @id @default(uuid())
  name              String
  type              OrganizationType
  licenseNumber     String?
  address           String?
  contactEmail      String?
  contactPhone      String?
  website           String?
  description       String?
  status            OrgStatus      @default(ACTIVE)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  parentId          String?
  parent            Organization?  @relation("OrganizationHierarchy", fields: [parentId], references: [id])
  children          Organization[] @relation("OrganizationHierarchy")
  users             User[]
  products          Product[]
}

model Subscription {
  id                String             @id @default(uuid())
  userId            String
  user              User               @relation(fields: [userId], references: [id])
  planId            String
  plan              SubscriptionPlan   @relation(fields: [planId], references: [id])
  status            SubscriptionStatus @default(ACTIVE)
  startDate         DateTime           @default(now())
  endDate           DateTime?
  autoRenew         Boolean            @default(true)
  paymentMethod     String?
  lastPaymentDate   DateTime?
  nextPaymentDate   DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  paymentHistory    Payment[]
}

model SubscriptionPlan {
  id                String         @id @default(uuid())
  name              String
  description       String?
  price             Float
  currency          String         @default("USD")
  interval          PlanInterval
  intervalCount     Int            @default(1)
  features          String[]
  isActive          Boolean        @default(true)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  subscriptions     Subscription[]
}

model Payment {
  id                String         @id @default(uuid())
  subscriptionId    String
  subscription      Subscription   @relation(fields: [subscriptionId], references: [id])
  amount            Float
  currency          String         @default("USD")
  status            SubscriptionPaymentStatus  @default(PENDING)
  paymentMethod     String?
  transactionId     String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
}

enum UserRole {
  USER
  INVESTOR
  ADMIN
  BROKER
  TRADER
  HR
  ACCOUNTING
  KELSOKO_ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum OrganizationType {
  KELSOKO
  BANK
  BROKER
  FUND
  SPECULATOR
  OTHER
}

enum OrgStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  EXPIRED
  PENDING
  FAILED
}

enum PlanInterval {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model Post {
  id                String         @id @default(uuid())
  userId            String
  user              User           @relation(fields: [userId], references: [id])
  content           String
  visibility        PostVisibility @default(PUBLIC)
  tradeSymbol       String?
  tradeType         TradeType?
  tradePrice        Float?
  analysisType      AnalysisType?
  analysisSummary   String?
  hashtags          String[]       @default([])
  mentions          String[]       @default([])
  attachments       Attachment[]
  likes             Int            @default(0)
  shares            Int            @default(0)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  comments          Comment[]
}

model Comment {
  id                String         @id @default(uuid())
  postId            String
  post              Post           @relation(fields: [postId], references: [id])
  userId            String
  content           String
  parentId          String?
  parent            Comment?       @relation("CommentReplies", fields: [parentId], references: [id])
  replies           Comment[]      @relation("CommentReplies")
  likes             Int            @default(0)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
}

model Attachment {
  id                String         @id @default(uuid())
  postId            String
  post              Post           @relation(fields: [postId], references: [id])
  type              AttachmentType
  url               String
  name              String
  size              Int
  createdAt         DateTime       @default(now())
}

enum PostVisibility {
  PUBLIC
  FOLLOWERS
  PRIVATE
}

enum TradeType {
  BUY
  SELL
}

enum AnalysisType {
  TECHNICAL
  FUNDAMENTAL
}

model Message {
  id                String         @id @default(uuid())
  senderId          String
  sender            User           @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId        String
  receiver          User           @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  content           String
  read              Boolean        @default(false)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
}

enum AttachmentType {
  IMAGE
  DOCUMENT
  VIDEO
}

model Trade {
  id                String         @id @default(uuid())
  userId            String
  symbol            String
  quantity          Int
  price             Float
  type              TradeType
  status            TradeStatus    @default(COMPLETED)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
}

enum TradeStatus {
  PENDING
  COMPLETED
  CANCELLED
  FAILED
}

model Stream {
  id                String         @id @default(uuid())
  userId            String
  user              User           @relation(fields: [userId], references: [id])
  title             String
  viewers           Int            @default(0)
  isLive            Boolean        @default(true)
  startTime         DateTime       @default(now())
  endTime           DateTime?
  mediaType         StreamMediaType
  mediaUrl          String?
  duration          Int?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
}

enum StreamMediaType {
  VIDEO
  AUDIO
}

// E-commerce models
model Product {
  id                String         @id @default(uuid())
  name              String
  description       String
  price             Float
  inventory         Int            @default(0)
  discount          Float?         @default(0)
  currency          String         @default("USD")
  isActive          Boolean        @default(true)
  categoryId        String
  category          Category       @relation(fields: [categoryId], references: [id])
  organizationId    String?
  organization      Organization?  @relation(fields: [organizationId], references: [id])
  images            ProductImage[]
  cartItems         CartItem[]
  orderItems        OrderItem[]
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
}

model ProductImage {
  id                String         @id @default(uuid())
  url               String
  isPrimary         Boolean        @default(false)
  productId         String
  product           Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
}

model Category {
  id                String         @id @default(uuid())
  name              String
  description       String?
  image             String?
  products          Product[]
  parentId          String?
  parent            Category?      @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children          Category[]     @relation("CategoryHierarchy")
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
}

model Cart {
  id                String         @id @default(uuid())
  userId            String
  user              User           @relation(fields: [userId], references: [id])
  items             CartItem[]
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
}

model CartItem {
  id                String         @id @default(uuid())
  cartId            String
  cart              Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId         String
  product           Product        @relation(fields: [productId], references: [id])
  quantity          Int
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
}

model Order {
  id                String         @id @default(uuid())
  userId            String
  user              User           @relation(fields: [userId], references: [id])
  status            OrderStatus    @default(PENDING)
  total             Float
  items             OrderItem[]
  shippingAddress   String?
  billingAddress    String?
  paymentMethod     String?
  paymentStatus     OrderPaymentStatus  @default(PENDING)
  trackingNumber    String?
  notes             String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
}

model OrderItem {
  id                String         @id @default(uuid())
  orderId           String
  order             Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId         String
  product           Product        @relation(fields: [productId], references: [id])
  quantity          Int
  price             Float          // Price at time of purchase
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum OrderPaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

// Futures trading models
model CommodityFuture {
  id                String              @id @default(uuid())
  name              String
  symbol            String              @unique
  baseAsset         String
  contractSize      Float
  unit              String
  expiryMonth       String
  expiryYear        Int
  price             Float
  change            Float               @default(0)
  openInterest      Int                 @default(0)
  volume            Int                 @default(0)
  initialMargin     Float
  maintenanceMargin Float
  status            FutureContractStatus @default(ACTIVE)
  lastUpdated       DateTime            @updatedAt
  createdAt         DateTime            @default(now())
  orders            FutureOrder[]
  trades            FutureTrade[]
}

model FxFuture {
  id                String              @id @default(uuid())
  name              String
  baseCurrency      String
  quoteCurrency     String
  expiryDates       FxExpiryDate[]
  minAmount         Float
  tickSize          Float               @default(0.0001)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
}

model FxExpiryDate {
  id                String              @id @default(uuid())
  date              DateTime
  displayName       String
  spotPrice         Float
  futurePremium     Float
  openInterest      Int                 @default(0)
  volume            Int                 @default(0)
  fxFutureId        String
  fxFuture          FxFuture            @relation(fields: [fxFutureId], references: [id], onDelete: Cascade)
  orders            FxFutureOrder[]
  trades            FxFutureTrade[]
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
}

model FutureOrder {
  id                String              @id @default(uuid())
  userId            String
  user              User                @relation(fields: [userId], references: [id])
  futureId          String
  future            CommodityFuture     @relation(fields: [futureId], references: [id])
  side              OrderSide
  price             Float
  quantity          Int
  status            OrderStatus
  filledQuantity    Int                 @default(0)
  timestamp         DateTime            @default(now())
  buyerTrades       FutureTrade[]       @relation("BuyerOrder")
  sellerTrades      FutureTrade[]       @relation("SellerOrder")
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
}

model FutureTrade {
  id                String              @id @default(uuid())
  futureId          String
  future            CommodityFuture     @relation(fields: [futureId], references: [id])
  price             Float
  quantity          Int
  buyerOrderId      String
  buyerOrder        FutureOrder         @relation("BuyerOrder", fields: [buyerOrderId], references: [id])
  sellerOrderId     String
  sellerOrder       FutureOrder         @relation("SellerOrder", fields: [sellerOrderId], references: [id])
  timestamp         DateTime            @default(now())
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
}

model FxFutureOrder {
  id                String              @id @default(uuid())
  userId            String
  user              User                @relation(fields: [userId], references: [id])
  expiryDateId      String
  expiryDate        FxExpiryDate        @relation(fields: [expiryDateId], references: [id])
  side              OrderSide
  price             Float
  quantity          Int
  status            OrderStatus
  filledQuantity    Int                 @default(0)
  timestamp         DateTime            @default(now())
  buyerTrades       FxFutureTrade[]     @relation("FxBuyerOrder")
  sellerTrades      FxFutureTrade[]     @relation("FxSellerOrder")
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
}

model FxFutureTrade {
  id                String              @id @default(uuid())
  expiryDateId      String
  expiryDate        FxExpiryDate        @relation(fields: [expiryDateId], references: [id])
  price             Float
  quantity          Int
  buyerOrderId      String
  buyerOrder        FxFutureOrder       @relation("FxBuyerOrder", fields: [buyerOrderId], references: [id])
  sellerOrderId     String
  sellerOrder       FxFutureOrder       @relation("FxSellerOrder", fields: [sellerOrderId], references: [id])
  timestamp         DateTime            @default(now())
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
}

enum FutureContractStatus {
  ACTIVE
  EXPIRED
  DELIVERY
  SETTLEMENT
}

enum OrderSide {
  BUY
  SELL
}

enum SubscriptionPaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}
